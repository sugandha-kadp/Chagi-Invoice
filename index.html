<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CSE Invoice Generator</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   APP UI STYLES
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: Arial, sans-serif; background: #f0f0f0; color: #111; padding: 20px; font-size: 14px; }
.wrap { max-width: 820px; margin: 0 auto; }
.app-header { text-align: center; margin-bottom: 22px; }
.app-header h1 { font-size: 1.4rem; font-weight: 700; }
.app-header p { color: #666; font-size: 0.84rem; margin-top: 3px; }
.card { background: #fff; border: 1px solid #ccc; border-radius: 8px; padding: 20px; margin-bottom: 14px; }
.card-title { font-size: 0.68rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: #666; border-bottom: 1px solid #eee; padding-bottom: 8px; margin-bottom: 14px; }
.row2 { display: flex; gap: 12px; }
.row2 > div { flex: 1; }
.row4 { display: flex; gap: 12px; }
.row4 > div { flex: 1; }
.mb12 { margin-bottom: 12px; }
label { display: block; font-size: 0.68rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: #666; margin-bottom: 4px; }
input, textarea { width: 100%; padding: 8px 10px; border: 1.5px solid #ccc; border-radius: 5px; font-family: Arial, sans-serif; font-size: 0.88rem; color: #111; background: #fafafa; outline: none; }
input:focus, textarea:focus { border-color: #1d4ed8; box-shadow: 0 0 0 3px rgba(29,78,216,0.1); background: #fff; }
textarea { resize: vertical; min-height: 60px; }
/* Items form table */
.fitbl { width: 100%; border-collapse: collapse; }
.fitbl thead tr { background: #1a1a1a; color: #fff; }
.fitbl thead th { padding: 8px 9px; font-size: 0.68rem; font-weight: 700; text-align: left; white-space: nowrap; }
.fitbl thead th.r { text-align: right; }
.fitbl tbody tr { border-bottom: 1px solid #eee; }
.fitbl tbody tr:hover { background: #f8f8f8; }
.fitbl td { padding: 4px 3px; vertical-align: middle; }
.fitbl td input { border: none; background: transparent; padding: 6px 8px; border-radius: 4px; font-size: 0.88rem; width: 100%; }
.fitbl td input:focus { background: #fff; border: 1.5px solid #1d4ed8; }
.fitbl .amtcell { text-align: right; font-weight: 600; padding: 6px 10px; font-size: 0.88rem; white-space: nowrap; }
.btn-del { background: none; border: none; cursor: pointer; color: #dc2626; font-size: 1rem; padding: 3px 8px; border-radius: 4px; }
.btn-del:hover { background: #fef2f2; }
.btn-add { margin-top: 10px; width: 100%; background: none; border: 2px dashed #ccc; color: #666; font-family: Arial, sans-serif; font-size: 0.85rem; font-weight: 700; cursor: pointer; padding: 8px; border-radius: 6px; }
.btn-add:hover { border-color: #1d4ed8; color: #1d4ed8; background: #eff6ff; }
.totals-wrap { margin-top: 14px; display: flex; justify-content: flex-end; }
.totals-box { width: 270px; border: 1px solid #ccc; border-radius: 7px; overflow: hidden; }
.trow { display: flex; justify-content: space-between; padding: 7px 14px; font-size: 0.88rem; border-bottom: 1px solid #eee; }
.trow:last-child { border: none; background: #1a1a1a; color: #fff; font-weight: 700; }
.trow .lbl { color: #666; }
.trow:last-child .lbl { color: rgba(255,255,255,0.6); }
.gst-ctrl { display: flex; align-items: center; gap: 10px; margin-top: 12px; flex-wrap: wrap; }
.gst-ctrl label { margin: 0; }
.gst-ctrl input { width: 75px; }
.gst-ctrl span { font-size: 0.8rem; color: #666; }
.actions { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-top: 18px; }
.btn { font-family: Arial, sans-serif; font-size: 0.88rem; font-weight: 700; padding: 10px 24px; border-radius: 7px; cursor: pointer; border: none; display: flex; align-items: center; gap: 6px; }
.btn-dark { background: #1a1a1a; color: #fff; }
.btn-dark:hover { background: #333; }
.btn-blue { background: #1d4ed8; color: #fff; }
.btn-blue:hover { background: #1e40af; }
.btn-out { background: #fff; color: #1a1a1a; border: 1.5px solid #ccc; }
.btn-out:hover { background: #1a1a1a; color: #fff; }
#preview-area { display: none; }
.preview-outer { background: #fff; border: 1px solid #ccc; border-radius: 8px; overflow: auto; box-shadow: 0 4px 18px rgba(0,0,0,0.08); margin-bottom: 14px; }

@media (max-width: 600px) {
  .row2, .row4 { flex-direction: column; }
  .actions { flex-direction: column; }
  .btn { justify-content: center; }
  .totals-wrap { justify-content: stretch; }
  .totals-box { width: 100%; }
  .preview-outer { overflow-x: auto; }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   INVOICE LAYOUT ‚Äî 100% TABLE-BASED
   No CSS Grid, no Flexbox = no overlap issues
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
#inv-inner {
  font-family: Arial, Helvetica, sans-serif;
  font-size: 12px;
  color: #000;
  background: #fff;
  width: 794px;
  padding: 36px 48px 40px 48px;
  line-height: 1.4;
}

/* Top bar */
#inv-inner .top-bar {
  text-align: right;
  font-size: 11px;
  font-weight: 700;
  margin-bottom: 16px;
}

/* Header layout table */
#inv-inner .hdr-table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 24px;
}
#inv-inner .hdr-table td {
  vertical-align: top;
  padding: 0;
}
#inv-inner .hdr-table .col-title {
  width: 320px;
}
#inv-inner .hdr-table .col-meta {
  width: 210px;
  padding-left: 0px;
}
#inv-inner .hdr-table .col-from {
  text-align: right;
}

/* TAX INVOICE ‚Äî single line, giant */
#inv-inner .tax-invoice-text {
  font-size: 44px;
  font-weight: 700;
  letter-spacing: -1px;
  line-height: 1;
  color: #000;
  display: block;
  white-space: nowrap;
  margin-bottom: 12px;
}
#inv-inner .customer-name {
  font-size: 12px;
  color: #000;
  line-height: 1.5;
}

/* Meta items */
#inv-inner .meta-key {
  font-size: 12px;
  font-weight: 700;
  display: block;
  color: #000;
  margin-top: 8px;
}
#inv-inner .meta-key:first-child { margin-top: 0; }
#inv-inner .meta-val {
  font-size: 12px;
  color: #333;
  display: block;
  margin-bottom: 2px;
}

/* From address */
#inv-inner .from-name {
  font-size: 12px;
  font-weight: 700;
  color: #000;
  display: block;
}
#inv-inner .from-addr {
  font-size: 12px;
  color: #333;
  line-height: 1.75;
  display: block;
}

/* Divider */
#inv-inner .divider {
  border: none;
  border-top: 1px solid #999;
  margin: 0 0 0 0;
}

/* Items table */
#inv-inner .items-tbl {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 0;
}
#inv-inner .items-tbl thead th {
  font-size: 12px;
  font-weight: 700;
  padding: 8px 8px;
  border-top: 1.5px solid #000;
  border-bottom: 1.5px solid #000;
  text-align: left;
  color: #000;
  white-space: nowrap;
}
#inv-inner .items-tbl thead th.r { text-align: right; }
#inv-inner .items-tbl thead th.c { text-align: center; }
#inv-inner .items-tbl tbody td {
  padding: 10px 8px;
  font-size: 12px;
  border-bottom: 1px solid #e0e0e0;
  color: #000;
  vertical-align: top;
}
#inv-inner .items-tbl tbody td.r { text-align: right; }
#inv-inner .items-tbl tbody td.c { text-align: center; }
#inv-inner .items-tbl tbody td.empty-row { color: #aaa; font-style: italic; }

/* Summary rows inside items table tfoot */
#inv-inner .items-tbl tfoot td {
  font-size: 12px;
  padding: 3px 8px;
  border: none;
  white-space: nowrap;
  color: #000;
}
#inv-inner .items-tbl tfoot .spacer-row td { padding-top: 10px; }
#inv-inner .items-tbl tfoot .sep-row td { padding: 2px 8px; }
#inv-inner .items-tbl tfoot .sep-row td.sep-line { border-bottom: 1px solid #999; padding-bottom: 3px; }
#inv-inner .items-tbl tfoot .total-row td {
  font-weight: 700;
  font-size: 12.5px;
  padding-top: 5px;
  padding-bottom: 4px;
}

/* Notes block */
#inv-inner .notes {
  margin-top: 22px;
  margin-bottom: 26px;
  font-size: 12px;
  line-height: 1.9;
}
#inv-inner .notes .due-date { font-weight: 700; }
#inv-inner .notes .bank-name { font-weight: 700; margin-top: 2px; display: block; }

/* Cut line */
#inv-inner .cut-wrap {
  margin-bottom: 14px;
}
#inv-inner .cut-table {
  width: 100%;
  border-collapse: collapse;
}
#inv-inner .cut-table td {
  vertical-align: middle;
  padding: 0;
}
#inv-inner .cut-table .cut-icon {
  width: 16px;
  font-size: 13px;
  color: #aaa;
  padding-right: 4px;
}
#inv-inner .cut-table .cut-line-cell {
  border-bottom: 1.5px dashed #bbb;
  height: 1px;
  padding: 0;
}

/* Payment Advice layout table */
#inv-inner .pa-table {
  width: 100%;
  border-collapse: collapse;
}
#inv-inner .pa-table > tbody > tr > td {
  vertical-align: top;
  padding: 0;
}
#inv-inner .pa-table .pa-left {
  width: 240px;
  padding-right: 20px;
}
#inv-inner .pa-title {
  font-size: 33px;
  font-weight: 700;
  letter-spacing: -0.5px;
  color: #000;
  line-height: 1;
  margin-bottom: 16px;
  white-space: nowrap;
  font-style: normal;
}
#inv-inner .pa-to-tbl {
  border-collapse: collapse;
  font-size: 12px;
  color: #333;
  line-height: 1.75;
}
#inv-inner .pa-to-tbl td { padding: 0; vertical-align: top; }
#inv-inner .pa-to-tbl .to-lbl { font-weight: 700; color: #000; padding-right: 8px; white-space: nowrap; }

/* PA detail table (right side) */
#inv-inner .pa-detail-tbl {
  width: 100%;
  border-collapse: collapse;
  font-size: 12px;
}
#inv-inner .pa-detail-tbl td {
  padding: 6px 0;
  border-bottom: 1px solid #ddd;
  vertical-align: top;
}
#inv-inner .pa-detail-tbl tr:last-child td { border-bottom: none; }
#inv-inner .pa-detail-tbl .dk { font-weight: 700; color: #000; padding-right: 8px; width: 48%; }
#inv-inner .pa-detail-tbl .dv { text-align: right; color: #000; }
#inv-inner .pa-detail-tbl .dv.bold { font-weight: 700; }
/* Amount Enclosed */
#inv-inner .enc-key { font-weight: 700; color: #000; font-size: 12px; display: block; padding-top: 4px; }
#inv-inner .enc-line { border-bottom: 1px solid #000; height: 18px; margin-top: 4px; }
#inv-inner .enc-hint { font-size: 10.5px; color: #666; margin-top: 3px; display: block; }
</style>
</head>
<body>
<div class="wrap">

  <div class="app-header">
    <h1>CSE Electrical Works ‚Äî Invoice Generator</h1>
    <p>Fill in details below, then Preview or Download PDF</p>
  </div>

  <!-- ‚ïê‚ïê FORM ‚ïê‚ïê -->
  <div id="form-section">

    <div class="card">
      <div class="card-title" style="display:flex;justify-content:space-between;align-items:center">
        <span>Your Business <span style="font-size:0.65rem;color:#22c55e;font-weight:600;letter-spacing:0">‚óè Saved automatically</span></span>
        <button onclick="resetCompany()" style="background:none;border:none;cursor:pointer;font-size:0.7rem;color:#999;text-decoration:underline;padding:0">Reset saved data</button>
      </div>
      <div class="row2 mb12">
        <div><label>Business Name</label><input id="biz-name" type="text" value="CSE Electrical Works Pvt Ltd"></div>
        <div><label>ACN Number</label><input id="biz-abn" type="text" placeholder="XX XXX XXX XXX"></div>
      </div>
      <div class="row2 mb12">
        <div><label>Company Email</label><input id="biz-email" type="email" placeholder="info@company.com.au"></div>
        <div></div>
      </div>
      <div><label>Address (one line per row)</label>
        <textarea id="biz-addr" rows="4" placeholder="Street Address&#10;SUBURB STATE&#10;POSTCODE&#10;COUNTRY"></textarea>
      </div>
    </div>

    <div class="card">
      <div class="card-title">Invoice Details</div>
      <div class="row4">
        <div><label>Invoice Number</label><input id="inv-num" type="text" placeholder="INV-0001"></div>
        <div><label>Invoice Date</label><input id="inv-date" type="date"></div>
        <div><label>Due Date</label><input id="due-date" type="date"></div>
        <div><label>Reference</label><input id="inv-ref" type="text" placeholder="Reference Number"></div>
      </div>
    </div>

    <div class="card">
      <div class="card-title">Customer</div>
      <div class="row2">
        <div><label>Customer Name</label><input id="cust-name" type="text" placeholder="Customer Name"></div>
        <div><label>Customer Email (optional)</label><input id="cust-email" type="email" placeholder="customer@email.com"></div>
      </div>
    </div>

    <div class="card">
      <div class="card-title">Line Items</div>
      <div style="overflow-x:auto">
        <table class="fitbl">
          <thead>
            <tr>
              <th style="width:36%">Description</th>
              <th style="width:10%;text-align:center">Qty</th>
              <th class="r" style="width:15%">Unit Price</th>
              <th class="r" style="width:11%">GST %</th>
              <th class="r" style="width:16%">Amount AUD</th>
              <th style="width:7%"></th>
            </tr>
          </thead>
          <tbody id="items-body"></tbody>
        </table>
      </div>
      <button class="btn-add" onclick="addRow()">Ôºã Add Line Item</button>
      <div class="gst-ctrl">
        <label>Default GST %</label>
        <input type="number" id="gst-rate" value="10" min="0" max="100" oninput="recalc()">
        <span>Australia standard = 10%</span>
      </div>
      <div class="totals-wrap">
        <div class="totals-box">
          <div class="trow"><span class="lbl">Subtotal</span><span id="t-sub">0.00</span></div>
          <div class="trow"><span class="lbl" id="gst-lbl">TOTAL GST 10%</span><span id="t-gst">0.00</span></div>
          <div class="trow"><span class="lbl">TOTAL AUD</span><span id="t-total">0.00</span></div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-title">Payment Notes</div>
      <div class="row2 mb12">
        <div><label>Payment Terms</label><input id="pay-terms" type="text" value="Payment due within 7 days"></div>
        <div><label>Bank / Account Name</label><input id="bank-name" type="text" value="CSE ELECTRICAL WORKS PVT LTD"></div>
      </div>
      <div class="row2">
        <div><label>BSB</label><input id="bank-bsb" type="text" placeholder="XXX XXX"></div>
        <div><label>Account Number</label><input id="bank-acc" type="text" placeholder="XXXXXXXXX"></div>
      </div>
    </div>

    <div class="actions">
      <button class="btn btn-out" onclick="clearAll()">üóë Clear</button>
      <button class="btn btn-dark" onclick="showPreview()">üëÅ Preview Invoice</button>
      <button class="btn btn-blue" onclick="downloadPDF()">‚¨á Download PDF</button>
    </div>
  </div>

  <!-- ‚ïê‚ïê PREVIEW ‚ïê‚ïê -->
  <div id="preview-area">
    <div class="preview-outer">
      <div id="inv-render"></div>
    </div>
    <div class="actions">
      <button class="btn btn-out" onclick="backToForm()">‚Üê Edit Invoice</button>
      <button class="btn btn-blue" onclick="downloadPDF()">‚¨á Download PDF</button>
    </div>
  </div>

</div><!-- /wrap -->

<script>
/* ‚îÄ‚îÄ Fields saved to localStorage ‚îÄ‚îÄ */
const COMPANY_FIELDS = ['biz-name','biz-abn','biz-email','biz-addr','bank-name','bank-bsb','bank-acc'];
const INV_NUM_KEY    = 'cse_last_inv_num';

function saveCompanyData(){
  COMPANY_FIELDS.forEach(id=>{
    localStorage.setItem('cse_'+id, document.getElementById(id).value);
  });
}

function loadCompanyData(){
  COMPANY_FIELDS.forEach(id=>{
    const saved = localStorage.getItem('cse_'+id);
    if(saved !== null && saved !== '') document.getElementById(id).value = saved;
  });
}

function nextInvNum(last){
  if(!last) return 'INV-1001';
  // Extract prefix and number e.g. "INV-0152" ‚Üí prefix="INV-", num=152
  const match = last.match(/^(.*?)(\d+)$/);
  if(!match) return last + '-1';
  const prefix = match[1];
  const num    = parseInt(match[2], 10);
  const padLen = match[2].length; // preserve zero-padding length
  const next   = num + 1;
  return prefix + String(next).padStart(padLen, '0');
}

/* ‚îÄ‚îÄ Auto-save company fields on change ‚îÄ‚îÄ */
function attachAutoSave(){
  COMPANY_FIELDS.forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.addEventListener('input', saveCompanyData);
  });
}

/* ‚îÄ‚îÄ Init ‚îÄ‚îÄ */
window.addEventListener('DOMContentLoaded', () => {
  // Load saved company data
  loadCompanyData();

  // Dates
  const today = new Date();
  document.getElementById('inv-date').valueAsDate = today;
  const due = new Date(today); due.setDate(due.getDate() + 7);
  document.getElementById('due-date').valueAsDate = due;

  // Smart invoice number ‚Äî next from last used
  const lastNum = localStorage.getItem(INV_NUM_KEY);
  document.getElementById('inv-num').value = nextInvNum(lastNum);

  addRow(); addRow(); addRow();
  attachAutoSave();
});

/* ‚îÄ‚îÄ Row management ‚îÄ‚îÄ */
let rid = 0;
function addRow() {
  rid++;
  const rate = parseFloat(document.getElementById('gst-rate').value) || 10;
  const tr = document.createElement('tr');
  tr.id = 'row' + rid;
  tr.innerHTML = `
    <td style="width:36%"><input type="text" placeholder="Description of work or service" oninput="rowCalc(${rid})"></td>
    <td style="width:10%"><input type="number" value="1" min="0" style="text-align:center" oninput="rowCalc(${rid})"></td>
    <td style="width:15%"><input type="number" placeholder="0.00" min="0" step="0.01" style="text-align:right" oninput="rowCalc(${rid})"></td>
    <td style="width:11%"><input type="number" value="${rate}" min="0" max="100" style="text-align:right" oninput="rowCalc(${rid})"></td>
    <td style="width:16%"><div class="amtcell" id="amt${rid}">0.00</div></td>
    <td style="width:7%;text-align:center"><button class="btn-del" onclick="delRow(${rid})">‚úï</button></td>
  `;
  document.getElementById('items-body').appendChild(tr);
  recalc();
}
function delRow(id) { const el=document.getElementById('row'+id); if(el)el.remove(); recalc(); }
function rowCalc(id) {
  const row=document.getElementById('row'+id); if(!row)return;
  const inp=row.querySelectorAll('input');
  document.getElementById('amt'+id).textContent = ((parseFloat(inp[1].value)||0)*(parseFloat(inp[2].value)||0)).toFixed(2);
  recalc();
}
function recalc() {
  let sub=0;
  document.querySelectorAll('[id^="amt"]').forEach(el=>{ sub+=parseFloat(el.textContent)||0; });
  const rate=parseFloat(document.getElementById('gst-rate').value)||0;
  const gst=sub*rate/100;
  document.getElementById('t-sub').textContent=sub.toFixed(2);
  document.getElementById('t-gst').textContent=gst.toFixed(2);
  document.getElementById('t-total').textContent=(sub+gst).toFixed(2);
  document.getElementById('gst-lbl').textContent='TOTAL GST '+rate+'%';
}

/* ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ */
function v(id){return document.getElementById(id).value.trim();}
function money(n){return parseFloat(n).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,',');}
function fmtDate(s){
  if(!s)return'';
  const[y,m,d]=s.split('-');
  return parseInt(d)+' '+['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][parseInt(m)-1]+' '+y;
}

/* ‚îÄ‚îÄ Gather data ‚îÄ‚îÄ */
function getData(){
  const rows=[];
  document.querySelectorAll('#items-body tr').forEach(tr=>{
    const inp=tr.querySelectorAll('input'); if(!inp.length)return;
    const desc=inp[0].value.trim(); if(!desc)return;
    const qty=parseFloat(inp[1].value)||0, unit=parseFloat(inp[2].value)||0, gstR=parseFloat(inp[3].value)||0;
    rows.push({desc,qty,unit,gstR,amt:qty*unit});
  });
  const gstRate=parseFloat(v('gst-rate'))||0;
  const sub=rows.reduce((s,r)=>s+r.amt,0), gst=sub*gstRate/100;
  return {
    bizName: v('biz-name')||'CSE Electrical Works Pvt Ltd',
    bizAbn:  v('biz-abn'),
    bizEmail:v('biz-email'),
    bizAddr: v('biz-addr'),
    invNum:  v('inv-num')||'INV-0001',
    invDate: fmtDate(v('inv-date')),
    dueDate: fmtDate(v('due-date')),
    invRef:  v('inv-ref'),
    custName:v('cust-name')||'Customer Name',
    custEmail:v('cust-email'),
    payTerms:v('pay-terms'),
    bankName:v('bank-name'),
    bankBsb: v('bank-bsb'),
    bankAcc: v('bank-acc'),
    rows, gstRate, sub, gst, total:sub+gst
  };
}

/* ‚îÄ‚îÄ Render invoice using TABLE layout only ‚îÄ‚îÄ */
function renderInvoice(d){
  // Address
  const addrLines=d.bizAddr.split('\n').map(l=>l.trim()).filter(Boolean);
  const addrHtml=addrLines.join('<br>');

  // Meta column HTML ‚Äî left-aligned labels, sits in centre column
  let metaHtml='';
  if(d.invDate)  metaHtml+=`<span class="meta-key">Invoice Date</span><span class="meta-val">${d.invDate}</span>`;
  metaHtml+=`<span class="meta-key">Invoice Number</span><span class="meta-val">${d.invNum}</span>`;
  if(d.invRef)   metaHtml+=`<span class="meta-key">Reference</span><span class="meta-val">${d.invRef}</span>`;
  if(d.bizAbn)   metaHtml+=`<span class="meta-key">ACN Number</span><span class="meta-val">${d.bizAbn}</span>`;

  // From column HTML ‚Äî right-aligned, name bold, then address, then email
  let fromHtml=`<div class="from-name">${d.bizName}</div>`;
  if(addrHtml)    fromHtml+=`<div class="from-addr">${addrHtml}</div>`;
  if(d.bizEmail)  fromHtml+=`<div class="from-addr" style="margin-top:2px">${d.bizEmail}</div>`;

  // Line items
  let itemsHtml='';
  if(d.rows.length){
    d.rows.forEach(r=>{
      itemsHtml+=`<tr>
        <td>${r.desc}</td>
        <td class="c">${r.qty.toFixed(2)}</td>
        <td class="r">${money(r.unit)}</td>
        <td class="r">${r.gstR}%</td>
        <td class="r">${money(r.amt)}</td>
      </tr>`;
    });
  } else {
    itemsHtml='<tr><td colspan="5" class="empty-row" style="padding:14px 8px">No items</td></tr>';
  }

  // Notes
  let notesHtml='';
  if(d.dueDate)   notesHtml+=`<span class="due-date">Due Date: ${d.dueDate}</span><br>`;
  if(d.payTerms)  notesHtml+=`${d.payTerms}<br>`;
  if(d.bankName)  notesHtml+=`<span class="bank-name">${d.bankName}</span>`;
  if(d.bankBsb)   notesHtml+=`<br>BSB: ${d.bankBsb}`;
  if(d.bankAcc)   notesHtml+=`<br>ACC: ${d.bankAcc}`;

  // PA address
  const paAddrHtml=addrLines.join('<br>');

  // PA detail rows
  let paRowsHtml='';
  paRowsHtml+=`<tr><td class="dk">Customer</td><td class="dv">${d.custName}</td></tr>`;
  paRowsHtml+=`<tr><td class="dk">Invoice Number</td><td class="dv">${d.invNum}</td></tr>`;
  paRowsHtml+=`<tr><td class="dk">Amount Due</td><td class="dv bold">${money(d.total)}</td></tr>`;
  if(d.dueDate) paRowsHtml+=`<tr><td class="dk">Due Date</td><td class="dv">${d.dueDate}</td></tr>`;
  paRowsHtml+=`
    <tr>
      <td class="dk" style="border-bottom:none;padding-top:6px">
        <span class="enc-key">Amount Enclosed</span>
      </td>
      <td style="border-bottom:none"></td>
    </tr>
    <tr>
      <td colspan="2" style="padding:0 0 0 0;border-bottom:1px solid #000">
        <div class="enc-line"></div>
      </td>
    </tr>
    <tr>
      <td colspan="2" style="border:none;padding-top:3px;padding-bottom:0">
        <span class="enc-hint">Enter the amount you are paying above</span>
      </td>
    </tr>`;

  return `<div id="inv-inner">

  <!-- Top bar -->
  <div class="top-bar">${d.bizName}</div>

  <!-- Header: TAX INVOICE | Meta | From -->
  <table class="hdr-table">
    <tbody>
      <tr>
        <td class="col-title">
          <span class="tax-invoice-text">TAX INVOICE</span>
          <div class="customer-name">${d.custName}${d.custEmail?'<br><span style="font-size:10.5px;color:#666">'+d.custEmail+'</span>':''}</div>
        </td>
        <td class="col-meta">${metaHtml}</td>
        <td class="col-from">${fromHtml}</td>
      </tr>
    </tbody>
  </table>

  <!-- Divider -->
  <hr class="divider">

  <!-- Line items table -->
  <table class="items-tbl">
    <thead>
      <tr>
        <th style="width:36%">Description</th>
        <th class="c" style="width:10%">Quantity</th>
        <th class="r" style="width:14%">Unit Price</th>
        <th class="r" style="width:9%">GST</th>
        <th class="r" style="width:18%">Amount AUD</th>
      </tr>
    </thead>
    <tbody>${itemsHtml}</tbody>
    <tfoot>
      <tr class="spacer-row">
        <td colspan="3" style="border:none"></td>
        <td style="text-align:right;color:#444;border:none;white-space:nowrap">Subtotal</td>
        <td style="text-align:right;border:none">${money(d.sub)}</td>
      </tr>
      <tr>
        <td colspan="3" style="border:none"></td>
        <td style="text-align:right;color:#444;border:none;white-space:nowrap">TOTAL GST ${d.gstRate}%</td>
        <td style="text-align:right;border:none">${money(d.gst)}</td>
      </tr>
      <tr class="sep-row">
        <td colspan="3" style="border:none;padding:1px 0"></td>
        <td class="sep-line" style="border-bottom:1px solid #999;padding:1px 8px"></td>
        <td class="sep-line" style="border-bottom:1px solid #999;padding:1px 8px"></td>
      </tr>
      <tr class="total-row">
        <td colspan="3" style="border:none"></td>
        <td style="text-align:right;font-weight:700;border:none;white-space:nowrap">TOTAL AUD</td>
        <td style="text-align:right;font-weight:700;border:none">${money(d.total)}</td>
      </tr>
    </tfoot>
  </table>

  <!-- Notes -->
  <div class="notes">${notesHtml}</div>

  <!-- Cut line -->
  <div class="cut-wrap">
    <table class="cut-table"><tbody><tr>
      <td class="cut-icon">‚úÇ</td>
      <td class="cut-line-cell"></td>
    </tr></tbody></table>
  </div>

  <!-- Payment Advice -->
  <table class="pa-table">
    <tbody>
      <tr>
        <td class="pa-left">
          <div class="pa-title">PAYMENT ADVICE</div>
          <div>
            <table class="pa-to-tbl">
              <tbody>
                <tr>
                  <td class="to-lbl">To:</td>
                  <td>${d.bizName}${paAddrHtml?'<br>'+paAddrHtml:''}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </td>
        <td>
          <div class="pa-detail-tbl" style="display:block">
            <table class="pa-detail-tbl">${paRowsHtml}</table>
          </div>
        </td>
      </tr>
    </tbody>
  </table>

</div>`;
}

/* ‚îÄ‚îÄ Preview / Back ‚îÄ‚îÄ */
function showPreview(){
  document.getElementById('inv-render').innerHTML=renderInvoice(getData());
  document.getElementById('form-section').style.display='none';
  document.getElementById('preview-area').style.display='block';
  window.scrollTo(0,0);
}
function backToForm(){
  document.getElementById('form-section').style.display='block';
  document.getElementById('preview-area').style.display='none';
}

/* ‚îÄ‚îÄ Download PDF ‚îÄ‚îÄ */
async function downloadPDF(){
  const d=getData();
  document.getElementById('inv-render').innerHTML=renderInvoice(d);
  const wasHidden=document.getElementById('preview-area').style.display!=='block';
  document.getElementById('preview-area').style.display='block';
  document.getElementById('form-section').style.display='none';
  await new Promise(r=>setTimeout(r,350));
  const el=document.getElementById('inv-inner');
  const {jsPDF}=window.jspdf;
  try{
    const canvas=await html2canvas(el,{
      scale:3, useCORS:true, backgroundColor:'#ffffff',
      logging:false, width:794, windowWidth:900
    });
    const imgData=canvas.toDataURL('image/jpeg',0.98);
    const pdf=new jsPDF({orientation:'portrait',unit:'mm',format:'a4'});
    const pw=pdf.internal.pageSize.getWidth();
    const ph=pdf.internal.pageSize.getHeight();
    const imgH=pw*(canvas.height/canvas.width);
    if(imgH<=ph){
      pdf.addImage(imgData,'JPEG',0,0,pw,imgH);
    } else {
      const pageHpx=(ph/pw)*canvas.width;
      let y=0;
      while(y<canvas.height){
        const pc=document.createElement('canvas');
        pc.width=canvas.width;
        pc.height=Math.min(pageHpx,canvas.height-y);
        pc.getContext('2d').drawImage(canvas,0,y,canvas.width,pc.height,0,0,canvas.width,pc.height);
        if(y>0)pdf.addPage();
        pdf.addImage(pc.toDataURL('image/jpeg',0.98),'JPEG',0,0,pw,(pc.height/canvas.width)*pw);
        y+=pageHpx;
      }
    }
    pdf.save(d.invNum+'.pdf');
    // Save invoice number so next time we suggest the next one
    localStorage.setItem(INV_NUM_KEY, d.invNum);
  } catch(e){ console.error(e); alert('PDF generation failed. Please try again.'); }
  if(wasHidden){
    document.getElementById('preview-area').style.display='none';
    document.getElementById('form-section').style.display='block';
  }
}

/* ‚îÄ‚îÄ Clear (invoice fields only ‚Äî company data is kept) ‚îÄ‚îÄ */
function clearAll(){
  if(!confirm('Clear invoice data? Your company details will be kept.'))return;
  // Reset only invoice/customer fields
  ['inv-ref','cust-name','cust-email'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('gst-rate').value=10;
  const today=new Date();
  document.getElementById('inv-date').valueAsDate=today;
  const due=new Date(today); due.setDate(due.getDate()+7);
  document.getElementById('due-date').valueAsDate=due;
  // Suggest next invoice number
  const lastNum = localStorage.getItem(INV_NUM_KEY);
  document.getElementById('inv-num').value = nextInvNum(lastNum);
  document.getElementById('items-body').innerHTML='';
  rid=0; addRow(); addRow(); addRow(); recalc();
}
/* ‚îÄ‚îÄ Reset company data ‚îÄ‚îÄ */
function resetCompany(){
  if(!confirm('Clear all saved company data?'))return;
  COMPANY_FIELDS.forEach(id=>{
    localStorage.removeItem('cse_'+id);
    document.getElementById(id).value='';
  });
  document.getElementById('biz-name').value='CSE Electrical Works Pvt Ltd';
  document.getElementById('bank-name').value='CSE ELECTRICAL WORKS PVT LTD';
}
</script>
</body>
</html>
